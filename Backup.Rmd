---
title: "Backup"
author: "Meilin Yan"
date: "August 4, 2016"
output: html_document
---
Crossbasis

```{r}
cb.1 <- function(rain = c(), city = c()){
      df <- city.storm(rain, city)
      cb <- crossbasis(df$hurr, lag = c(0, 10), 
                      argvar = list("lin", cen = 0),
                      arglag = list("integer"))
      return(cb)
}
```

Model

```{r}
mod.1 <- function(rain = c(), city = c(), cause = c()){
     df <- city.storm(rain, city)
     cb <- cb.1(rain, city)
     
     fit <- glm(df[, cause] ~ cb + ns(dptp, 3) + ns(tmpd, 3) + strata , 
                family = quasipoisson(link = log),
                data = df,
                control = glm.control(epsilon = 10E-8, maxit = 10000))
     
     pred <- crosspred(cb, fit, at = 1, cumul = TRUE)
     
     re <- crossreduce(cb, fit)
     
     return(list("fit" = fit, "pred" = pred, "re" = re))
}
```

# Extract cummulative coefficients (effects) and standard errors for meta analysis

```{r eval=FALSE, include = FALSE}
cum.coef.1 <- function(rain = c(), city = c(), cause = c()){
              mod <- mod.1(rain, city, cause)
              pred <- mod$pred
              cum.fit <- pred$allfit
              cum.se <- pred$allse
              return(c(cum.fit, cum.se))
              #return(list("cum.fit" = cum.fit, "cum.se" = cum.se))
}
```

Save cummulative coefficents and standard erros.

Now I extract and save the cumulative coefficients and SE for all death and accidental death, respectively. I think we can save them in one data set and do meta-analysis by treating them as matrix. However, I don't know how to get the correlation of standard errors of all death and accidental death since the cumulative SE is just one number. Is it correct to calculate the correlation of cumulative SE for each lag day?

## For cities with 75mm rain limit

```{r}
df75 <- readRDS("data/df75.rds")
city.names.75 <- unique(df75$loc) # 61 cities

# All death
cum.rain75.all <- data.frame()
suppressWarnings(
for(i in 1:length(city.names.75)){
  city <- city.names.75[i]
  cum.coef <- cum.coef.1("rain75", city, "all")
  cum.rain75.all <- rbind(cum.rain75.all, cum.coef)
})
colnames(cum.rain75.all) <- c("cum.fit", "cum.se")
saveRDS(cum.rain75.all, file = "data/cum.rain75.all.rds")

# Accidental death
cum.rain75.acci <- data.frame()
suppressWarnings(
for(i in 1:length(city.names.75)){
  city <- city.names.75[i]
  cum.coef <- cum.coef.1("rain75", city, "accident")
  cum.rain75.acci <- rbind(cum.rain75.acci, cum.coef)
})
colnames(cum.rain75.acci) <- c("cum.fit", "cum.se")
saveRDS(cum.rain75.acci, file = "data/cum.rain75.acci.rds")
```

## For cities with 125mm rain limit

```{r}
df125 <- readRDS("data/df125.rds")
city.names.125 <- unique(df125$loc) # 32 cities

# All death
cum.rain125.all <- data.frame()
suppressWarnings(
for(i in 1:length(city.names.125)){
  city <- city.names.125[i]
  cum.coef <- cum.coef.1("rain125", city, "all")
  cum.rain125.all <- rbind(cum.rain125.all, cum.coef)
})
colnames(cum.rain125.all) <- c("cum.fit", "cum.se")
saveRDS(cum.rain125.all, file = "data/cum.rain125.all.rds")

# Accidental death
cum.rain125.acci <- data.frame()
suppressWarnings(
for(i in 1:length(city.names.125)){
  city <- city.names.125[i]
  cum.coef <- cum.coef.1("rain125", city, "accident")
  cum.rain125.acci <- rbind(cum.rain125.acci, cum.coef)
})
colnames(cum.rain125.acci) <- c("cum.fit", "cum.se")
saveRDS(cum.rain125.acci, file = "data/cum.rain125.acci.rds")
```

## For cities with 175mm rain limit

```{r}
df175 <- readRDS("data/df175.rds")
city.names.175 <- unique(df175$loc) # 13 cities
city.names.175 <- city.names.175[-c(6, 11)] # Remove "mobi" and "orla"

# All death
cum.rain175.all <- data.frame()
suppressWarnings(
for(i in 1:length(city.names.175)){
  city <- city.names.175[i]
  cum.coef <- cum.coef.1("rain175", city, "all")
  cum.rain175.all <- rbind(cum.rain175.all, cum.coef)
})
colnames(cum.rain175.all) <- c("cum.fit", "cum.se")
saveRDS(cum.rain175.all, file = "data/cum.rain175.all.rds")

# Accidental death
cum.rain175.acci <- data.frame()
suppressWarnings(
for(i in 1:length(city.names.175)){
  city <- city.names.175[i]
  cum.coef <- cum.coef.1("rain175", city, "accident")
  cum.rain175.acci <- rbind(cum.rain175.acci, cum.coef)
})
colnames(cum.rain175.acci) <- c("cum.fit", "cum.se")
saveRDS(cum.rain175.acci, file = "data/cum.rain175.acci.rds")
```

Plot
```{r}
plot.1 <- function(rain = c(), city = c(), cause = c()){
          df <- city.storm(rain, city)
          mod <- mod.1(rain, city, cause)
          pred <- mod$pred
          
          cityname <- unique(df$cityname)
          title <- paste(cityname, "-", cause, seq = "")
     
          plot <- plot(pred, "slices", var = 1, type = "p", ci = "bars", 
                       ylim = c(0, 10), main = title)
          
          return(plot)
}
```

Function of getting estimates
```{r eval=FALSE, include=FALSE}
# Get EST and SE from the model
Cal.estimates <- function(rain = c(), city = c(), cause = c()){
  mod <- mod.1(rain, city, cause)
  pred <- mod$pred
  # Estimated coef
  est <- pred$matfit
  est <- as.data.frame(t(est))
  # Estimated SE
  se <- pred$matse
  se <- as.data.frame(t(se))
  
  return(list("est" = est, "se" = se))
}

# Get results for each city
Est.city <- function(rain = c(), city = c()){
  est.city <- data.frame(matrix(NA, nrow = 12, ncol = 6))
  colnames(est.city) <- c("loc", "lag", "all.est", "all.se", "acc.est", "acc.se")
  est.city$loc <- rep(city, 12) 
  est.city$lag <- c(-1:10)
 
  est.city$all.est <- Cal.estimates(rain, city, "all")$est[, 1]
  est.city$all.se <- Cal.estimates(rain, city, "all")$se[, 1]
  est.city$acc.est <- Cal.estimates(rain, city, "accident")$est[, 1]
  est.city$acc.se <- Cal.estimates(rain, city, "accident")$se[, 1]

  return(est.city)
}
```



## For cities with 75mm rain 

Plot single lag effects
```{r}
pdf("Plots/single_lag_rain75.pdf", width = 7, height = 10)
par(mfrow = c(2, 1))
df75 <- readRDS("data/df75.rds")
city.names.75 <- unique(df75$loc) # 57 cities

for(city in city.names.75){
  city.all <- mod.1("rain75", city, "all")$plot
  city.acc <- mod.1("rain75", city, "accident")$plot
}
dev.off()
```

*NOTE: I am going to check out these result plots by comparing with "75mm" which shows rain and number of storms for each city *

Get estimates
```{r}
# Combine results for all cities
Est.rain75 <- data.frame()
for(i in 1:length(city.names.75)){
  city <- city.names.75[i]
  es <- Est.city("rain75", city)
  Est.rain75 <- rbind(Est.rain75, es)}

# Add city fullname
sub.county <- readRDS("data/sub.county.rds")
city.ab.75 <- Est.rain75$loc
for(city in city.ab.75){
    Est.rain75$cityname[Est.rain75$loc == city] <-
      sub.county$citynameU[sub.county$city == city]
}
# save results
saveRDS(Est.rain75, file = "data/Est.rain75.rds")
```

## For cities with 125mm rain

Plot single lag effects
```{r}
pdf("Plots/single_lag_rain125.pdf", width = 7, height = 10)
par(mfrow = c(2, 1))
df125 <- readRDS("data/df125.rds")
city.names.125 <- unique(df125$loc) # 27 cities

for(city in city.names.125){
  city.all <- mod.1("rain125", city, "all")$plot
  city.acc <- mod.1("rain125", city, "accident")$plot
}
dev.off()
```

Get estimates
```{r}
# Combine results for all cities
Est.rain125 <- data.frame()
for(i in 1:length(city.names.125)){
  city <- city.names.125[i]
  es <- Est.city("rain125", city)
  Est.rain125 <- rbind(Est.rain125, es)}

# Add city fullname
city.ab.125 <- Est.rain125$loc
for(city in city.ab.125){
    Est.rain125$cityname[Est.rain125$loc == city] <-
      sub.county$citynameU[sub.county$city == city]
}
# save results
saveRDS(Est.rain125, file = "data/Est.rain125.rds")
```

## For cities with 175mm rain
* Not work now* 
Something would be worong when running code for "mobi"

Plot single lag effects
```{r eval = FALSE}
pdf("Plots/single_lag_rain175.pdf", width = 7, height = 10)
par(mfrow = c(2, 1))
df175 <- readRDS("data/df175.rds")
city.names.175 <- unique(df175$loc) # 11 cities

for(city in city.names.175){
  city.all <- mod.1("rain175", city, "all")$plot
  city.acc <- mod.1("rain175", city, "accident")$plot
}
dev.off()
```

Get estimates
```{r eval = FALSE}
# Combine results for all cities
Est.rain175 <- data.frame()
for(i in 1:length(city.names.175)){
  city <- city.names.175[i]
  es <- Est.city("rain175", city)
  Est.rain75 <- rbind(Est.rain175, es)}

# Add city fullname
sub.county <- readRDS("data/sub.county.rds")
city.ab.175 <- Est.rain175$loc
for(city in city.ab.175){
    Est.rain175$cityname[Est.rain175$loc == city] <-
      sub.county$citynameU[sub.county$city == city]
}
# save results
saveRDS(Est.rain175, file = "data/Est.rain175.rds")
```